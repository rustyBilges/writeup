%TODO: Most abundant species osciallte more?Interesting question: is this true across the board, and are their oscillations only large in ampltitude because their mean is greater - what is the distribution of CoVs..later in chapter?
%TODO: revist chp3 results - CoV contigusous vs random HL \\
%TODO: replace ranomd walk with ARIMA? \\
%TODO: ensemble RW and NS with boxplots? \\
%TODO: Fix RAS plots (ordering) \\
%TODO: Put in IR vs HL results\\
%TODO: Test for determinism and chaos\\
%TODO: Conclude! \\
%TODO: how do metrics vary with measurement length/through time - how likely get wrong result from snapshot (distribution of results?) \\
%TODO: Add species labels (most abundant) to species dynamics figure \\
%TODO: Fix labelling on least/most abundant stat test figure. Shuold be A-D. And in caption.  \\
%TODO: Fix colours on ensebmle figure (1.7A) red and blue switched!

\section{Motivation}
\label{sec:motivate_stationarity}

We look here at stationairty because it was seen in previous chapter that in certain circumstances the population dynamcis become highly variable, as measured by the temporal variability metric.  

Ecological relevance...There has been a strong tradition of understanding ecosystems as existing at of near some stochastic equilbirium or steady state \cite{brock1967ecosystem} (issue of short time scale fluctuations and thermodynamics systems). This is motivated partly by obersvation of constancy in ecological communties through time [REFS] and also by thoereitcal considerations - for examples various stability metrics require the assumption of a stable eqilibrium.. stability people \ref{arnolid2015} and section \ref{sec:whereis}. 

There is also the concern that high variability affects the results we present...previously results were collected..but averaged over replicates...here we look for stationarity..if stationary..we also look at how results differ depending on how they are measured for a highgly viriable simulation...OUTLINE WHAT IS TO FOLLOW:

\begin{itemize}
	\item Thermodynamic equilibrium is...therefore can talk about extrinsic state variables..
	\item Different concepts of equilibirium in ecology - IBT suggest that island communities exists in a dynamic equilibirum between immigration and local extinctions..\cite{simberloff1974equilibrium}.
	\item Steady-state can mean different things in different contexts. In general we define it as a condition under which certain properties of the system can be defined which are unchanging in time. For example..a chaotic attractor can be considered a steady-state
	\item Whether or not real we consider... 
	\item Chaotic attractor could be steady-state..
\end{itemize}


In the previous work (\cite{lurgi2015effects} and section \ref{whereis}) the results presenetd were mainly taken as a final value at the end of the simulation. This is true for the Diversity and Abundance metrics, taken form outputecosystem. This is also true of mutualistic subnetwork - which is only taken at the final iteration (over period of 200 iterations). And Network properties are all caculated from the final 200 iterations of the simultion i.e 4800 to 5000. Here we investigate this, the assumptions behind it and the potential affect on results. This invesitgation is in part inspired by the result that the CoV in the total biomass increases as the IR is dreceased, bringing into question the assumptions behind taking `snapshot results'.

%  iteration, total_sp, total_count, prod_sp, prod_count, mut_prod_sp, mut_prod_count, herb_sp, herb_count, mut_sp, mut_count, prim_pred_sp, prim_pred_count, sec_pred_sp, sec_pred_count, shannon_index, shannon_eq, shannon_index_prods, shannon_eq_prods, shannon_index_herbs, shannon_eq_herbs, shannon_index_interm, shannon_eq_interm, shannon_index_top, shannon_eq_top.

As discussed above the stationarity of our simulation output is primarliy of interest for the pratical reasons of obtaining reliable results. However it is also of interest for various reasons relating to ecological theory.


A reasonable hypothesis is that the dynamics contains a deterministic and a stochastic component. Determinsitic component must be stable..to explain lack of extinctions...Noise can induce oscialltions about stable equilibrium [REF]. Or the oscialltions may be deterministic in nature, suggesting a high dimensional attractor. Although this could be considered a steady-state, as discussed, it does not necessarily appear stationary. This would depend on the magnitude of the oscillations. This raises an important point about equilbria and stationarity, adn may motivate further types of test...

\section{Second-order stationarity}

%\begin{itemize}
%	\item Justify choice of weak-stationarity
%	\item discuss tests for weak stationarity e.g. Nason \cite{ref:nason2013test}. PSR. ADF. KPSS. define them.
%	\item mention use of wavelets in ecological time series - reffer to PSR test 		
%	\item Choice of metric to look at : total number of individuals, or by species?? (justify both..)
%\end{itemize}

We introduce here three tests for second-order (or `weak') stationarity in time series.  Second-order stationarity may be defined as the time invariance of the first and second moments of the data. Specifically Hsu \cite{hsu1997schaum} states that a random process $X(t), t \in \mathbf{Z}^+$ is second-order stationary if:

\begin{eqnarray*}
	\mathbf{E}[X(t)] &=& \mu \text{ (constant),} \\
	R_X(t,s) &=& \mathbf{E}[X(t)X(s)] = R_X(|s-t|), 
\end{eqnarray*}

where $R_X(t,s)$ is the \emph{autocorrelation} function of the process. Conceptually these conditions state that a second-order stationary time series has constant mean and autocorrelation dependent only on time separation. From now on we will refer to this just as \emph{stationary}. If the conditions are not met we call the time series \emph{non-stationary}, and we cannot parameterise a constant distribution for the data. Non-stationarity may be due, for example, to a trend in the data or a change in the parameters of the data generator. 

In our case the data generator is the IBM model and there are several possible causes of non-stationarity. It may be that there is no steady-state equilibrium in the model. For example the number of individuals may undergo a random-walk. From previous analysis this situation seems unlikely, since we have observed what appear to be deterministic population cycles. However randomness has not been explicitly tested for. Another possibility is that a steady-state equilibirium exists, but that a long transience  means it is not reached during the time frame of our simulations\footnote{Move to motivation or discussion?}. 

%%Intuitively this is the definition of stationarity we are looking for in the model output - if the generated time series is weakly stationary then the simulation has reached a steady state distribution, and the results that we take involve sampling from this distribution. The repeatability of the results then only depends on the properties of this dsitribution (we also need to look at individual species..see later). 

\subsection{Tests for stationarity}
\label{sec:stat_tests}

We compare three different tests of stationarity: the Kwiatkowski-Phillips-Schmidt-Shin (KPSS) \cite{kwiatkowski1992testing}; the Augmented Dickey-Fuller (ADF) \cite{said1984testing}; and the the Priestley-Subba Rao (PSR) \cite{priestley1969test} tests. These tests were chosen for their popularity in the time series literature. All three are implemented in the programming language \emph{R} \cite{Rlanguage} - the former two in the package \emph{tseries}, and the latter in the package \emph{fractal}.

The ADF test has null hypothesis that the time series is non-stationary. The test models the data as an auto-regressive process (see section \ref{sec:stationarity_discussion}), and the null hypothesis is that this process has a \emph{unit root}. The test produces a statistic that is negative. The greater the magnitude of the test statistic the more evidence there is to reject the null hypothesis in favour of stationarity.

The KPSS test complements the ADF test in that the null hypothesis is stationarity. The data is modelled as the sum of a random-walk and an error component, and tests the hypothesis that the variance of the random walk is zero. The test statistic is always positive, and the greater its magnitude the more evidence there is to reject the null hypothesis in favour of non-stationarity.

The null hypothesis of the PSR test is also that the series is stationary. The test is based on the idea that non-stationary processes have power stectra that change over time \cite{priestley1969test}. These are called \emph{evolutionary spectra}. The test, as implemented in \emph{R}, returns several statistics. We quote the `p-value for T' which can be thought of as the confidence that the estimated spectral density functions are constant in time.

\subsection{Characterising the tests}
\label{sec:characterising_stat_tests}

%% metnion that time series must be one-D??

To understand the performance of the stationarity tests (section \ref{sec:stat_tests}) we apply them to three example time series, which we refer to as HI, RW and NS. The first series, HI, is taken from a single IBM simulation run with high immigration rate (IR$=0.001$), zero mutualism (MAI$=0.0$) and otherwise default parameters (table \ref{tab:whereis}).  The series represents the total number of individuals of all species at each iteration. The simulation was run for 50,000 iterations, compared with the 5000 used in previous chapters. This increased length increases the chance of the simulation reaching stead-state, and allows comparison of tests applied to different sections of the series. The first 1000 iterations were discarded, since these contain clearly transient dynamics (see figure \ref{fig:hi_trophic_dynamics}B), leaving a time series of 49,000 points. A high immigration rate was chosen because it reduces the temporal variability of the dynamics, as was discussed in chapter \ref{chap:varying_immigration_rate}. Therefore the HI series is more likely to be stationary than the output of a simulation with a lower IR.

The series RW and NS are chosen as a negative and a positive control respectively. Both have the same length as HI. RW is a non-stationary series generated by a one-dimensional \emph{random-walk}, defined as:

\begin{equation}
	x(t) = \Sigma_{t}^{i=1} Z_i, 
\end{equation}   

where $Z_i$ are independent random variables that may take a value of either $-10$ or $+10$, both with probabaility half. An ensemble of such random walks was generated and a single instance was chosen with mean and variance closest to the HI series. RW has a mean and standard deviation of 15525.2 and 1549.8 respectively, compared to 15915.8 and 1545.6 for HI. For comparison, NS is a stationary series generated by drawing each value independently from a normal distribution with mean and variance  equal to that of HI. The three series are plotted in figure \ref{fig:adf}.
  
%We know that such a series is non-stationary in general (although it may appear stationary by chance?).
  
\begin{figure}[ht]
	\centering
	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/hi_rw_ns_dynamics"}
     \caption{The three time series used to characterise the performance of the stationarity tests. The intial 1000 points removed such that all are 49,000 points long. \textbf{(A) HI}: total abundance dynamics of an IBM simualtion with high immigration rate; \textbf{(B) RW}: a random walk without drift, as described in the text; and \textbf{(C) NS}: a series generated by independent sampling from a normal distribution.} 
     \label{fig:adf}   
\end{figure}

\begin{table}[h]
\centering
\label{tab:adf_psr_kpss_whole}
\begin{tabular}{|
>{\columncolor[HTML]{C0C0C0}}c |c|
>{\columncolor[HTML]{9AFF99}}c |c|c|c|c|}
\hline
   & \multicolumn{2}{c|}{\cellcolor[HTML]{C0C0C0}A.D.F.}                 & \multicolumn{2}{c|}{\cellcolor[HTML]{C0C0C0}P.S.R.}              & \multicolumn{2}{c|}{\cellcolor[HTML]{C0C0C0}K.P.S.S.}                  \\ \hline
   & \cellcolor[HTML]{C0C0C0}stat & \cellcolor[HTML]{C0C0C0}p-value      & \cellcolor[HTML]{C0C0C0}stat & \cellcolor[HTML]{C0C0C0}p-value   & \cellcolor[HTML]{C0C0C0}stat & \cellcolor[HTML]{C0C0C0}p-value         \\ \hline
HI & -15.401                      & {\color[HTML]{333333} \textless0.01} & -                            & 0.0004782808                      & 0.5395                       & 0.03277                                 \\ \hline
RW & -4.0386                      & {\color[HTML]{333333} \textless0.01} & -                            & \cellcolor[HTML]{9AFF99}0.9929773 & 18.7453                      & \textless0.01                           \\ \hline
NS & -37.5348                     & {\color[HTML]{333333} \textless0.01} & -                            & \cellcolor[HTML]{9AFF99}0.811097  & 0.0466                       & \cellcolor[HTML]{9AFF99}\textgreater0.1 \\ \hline
\end{tabular}
\caption{Results of applying the three stationarity tests to the example time series shown in figure \ref{fig:adf}. P-values that indicate evidence for stationarity at $95\%$ confidence are highlighted in green. The test statistics are also given for the ADF and KPSS tests.}
\end{table}

Initially we apply the three stationarity tests to the entire length of the time series. The results are shown in table \ref{tab:adf_psr_kpss_whole}. ADF finds significant evidence that all three series are stationary, at $99\%$ confidence. We may be suspicious of this result since we know that RW is generated by a non-stationary process.  However this is a special case of a random walk, chosen from several thousand to closley match the mean and variance of HI. Therefore it may not be unreasonable that it can pass as stationary. The test statistic for ADF indicates that there is most evidence for NS to be stationary, followed by HI, then RW.
  The KPSS test ranks the series in the same order, based on the magnitude of the test statistic. According to this test NS is clearly stationary (accept h0), and RW is clearly non-stationary (reject h0 at $99\%$ confidence\footnote{This may not be suprising - or RW not a good test case - since the test models the data as a random-walk!}), whilst HI is borderline. For HI we would accept the null-hypothesis of stationarity at $95\%$ confidence, but reject it at $99\%$. 

The PSR test gives unexpected results. It concludes that RW and NS are both stationary, whilst HI is non-stationary with a high degree of confidence (p-value$<0.001$). In fact, according to PSR, RW is more likely to be stationary than NS. This result contradicts what we know about the series. Therefore we do not use this test in the analysis that follows. However the apparently erroneous result may contain interesting information about the HI series and the process that generated it (see discussion in section \ref{sec:stationarity_discussion}. 


%% WUOLD BE NICE BUT ANALYSIS NEEDS RE-DOING...
%\begin{figure}[hp]
%	\centering
%    \subbottom[Sample size = 1000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/hi_rw_ns_zscore_wl1000"}}
%    \subbottom[Sample size = 5000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/hi_rw_ns_zscore_wl5000"}}
%        \caption{The z-statistic used to test the null hypothesis that sample means are drawn from the stationary distribution. Each dot indicates a sample from the dynamics, which is tested.}    
%    \label{fig:zscore}
%\end{figure}

\newpage

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.80\linewidth]{"./chapters/chapter04b/figures/Rtests/stat_tests_v_wl"}
     \caption{Two tests for stationarity applied to samples of varying size (window length). Samples are taken from the three time series (HI,RW,NS) shown in figure \ref{fig:adf}. All three time series contain 49,000 points. Sample windows begin at the first point and increase in length from 1000 to 49,000 points. Points plotted at 0.01 indicate p-values less than or equal to this. (A) ADF test, with p-values capped at 0.20. 95th and 99th percentile in yellow and green respectively, indicating significant vidence for stationarity. (B) KPSS test, with p-values capped at 0.1. 95th and 99th percentile in orange and red respectively, indicating significant evidence for non-stationarity.} 
     \label{fig:stat_tests_v_wl}   
\end{figure}

Having discarded the PSR test, we now apply ADF and KPSS to samples of varying sizes, taken from the three series (HI,RW,NS). Sampling begins at the first point of the series and takes consecutive points up to the desired lenght of samples. Sample lengths range from 1000 to 49,000 data points. Again, as we saw in table \ref{tab:adf_psr_kpss_whole}, the two tests perform differently. The KPSS test correctly identifies RW and NS as non-stationary and stationary respectively, for all sample sizes. This is shown in figure \ref{fig:stat_tests_v_wl}B. The ADF test (figure \ref{fig:stat_tests_v_wl}A) correctly identifies NS as stationary for all sample sizes.  For short sample sizes it also correctly idetifies RW as non-stationary. However, for sample sizes much above 20,000, ADF finds significant evidence that RW is stationary at $95\%$ confidence. This is an interesting result. Although RW is generated by a non-stationary process, it appears to fool the ADF test by staying `stationary enough' over many time points. 
  
There is mixed evidence for the stationarity of HI, as shown in figure \ref{fig:stat_tests_v_wl}. ADF, for all sample sizes above 2000, finds significant evidence that HI is stationary. Whereas KPSS, on the whole, gives significant evidence that HI is non-stationary - There are only seven cases where there is insufficient evidence to reject the null hypothesis that the HI series is stationary, and these occur at sample sizes between 24,000 and 34,000. From these results it appears that the KPSS test is a stricter test of stationarity, and is less sensitive to the size of the sample. Although it appears that the ADF test is biased in favour of stationarity, it does order the series correctly in the above examples and is a useful complement to KPSS. Also it may be that the sensitivity of ADF to sample length is useful, since processes may appear stationary/non-stationary at different scales. 

We consider the possibility that the method of sampling from the time series affects the results of the stationarity tests. For example samples taken near the beginning of an IBM simulation run may be more likely to give the non-stationary series because of transient dynamics. Alternatively a non-stationary data generator may produce sections of time series that appear stationary purely by chance. This sensitivtiy to sampling is investigated by \emph{reversing} the time series and repeating the above analysis. For HI, RW and NS we see no qualititive change in the results presented above. We also scan sampling windows of fixed length along the series to look for time dependence in the test results. The time at which samples are taken appears to make no qualitative difference, and there is no systematic change in the results that would suggest the simulation becomes more stationary the longer it is run\footnote{Note that this is not necessarily the case when we move to lwoer IRs.}. 


%% THINK THIS IS NOT NEED TO CHARACTERISE THE TESTS..MAYBE JUST DISCUSS IN THE TEXT?
%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/stat_tests_v_time"}
%     \caption{Similar to figure \ref{fig:stat_tests_v_wl} but with samples of fixed sample size taken from different parts of the time series. To sample windows of given length (wl) are moved along the series and the tests are applied to the sub-series that falls within the window. Results are plotted against the mid-point of the window.}
%     \label{fig:stat_tests_v_time}   
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/hi_trophic_dynamics"}
     \caption{Dynamics for the HI simulation, broken down by trophic level ($TL1-4$). Abundance is measured by the number of individuals. (A) The whole simulation run of 50,000 iterations. (B) Enlaregement of first 1000 iterations, showing transience.} 
     \label{fig:hi_trophic_dynamics}   
\end{figure}


\paragraph*{HI simulation.}
We now focus on the simulation data used to generate HI and look in more depth at whether this dataset can be considered stationary. We use the same two tests, ADF and KPSS, for the stationarity of univariate time series. Since our abundunace vector is 60-dminesional ($N=60$ species), it is necessary to perform some manipulation to get a time series we can test. Previously we used the total number of individuals as our time series. However simply summing over species (l1-norm) is not nessearily the most informative metric to use. One possible issue is that the phase differences between species oscillations that we would expect due to trophic interactions (see chapter \ref{chap:whereis}) may mean that temporal variability is cancelled out when aggregating abundances in this way. It is possible that simulations which appear stationary according to some aggregate metric (e.g. total number of species) may have non-stationary underlying dynamics. This suggests that it is most informative to consider stationartiy at the species level. We also consider the stationarity of abundances by trophic level, as an alternative aggregate metric.

The dynamics of the HI simulation are aggregated by trophic level to create four new time series TL$1-4$. These \emph{trophic dynamics} are plotted in figure \ref{fig:hi_trophic_dynamics}. The intial period of transience is expanded in panel B. As in the previous analysis this part of the time series (first 1000 iterations) is removed. The ADF and KPSS tests are applied to the four trophic series separately and the results are shown in figure \ref{fig:tl_stat_tests_v_wl}. According to ADF all trophic levels are stationary for samples sizes greater than 4000. TL1 appears to be least stationary according to ADF, requiring a sample size of at least 4000 before to reject the null hypothesis at $95\%$ confidence. According to KPSS TL1 is non-stationary for all sample sizes, whilst TL2 and 3 are stationary for samples sizes above 6000 and 1000 respectively. KPSS gives mixed results for TL4, with no clear dependnence on sample size. It is hard to reconcile these results with an observation of the dynamics in figure \ref{fig:hi_trophic_dynamics}, indicating the usefulness of the statistical tests. It may be informative to consider if there are general trends in the stationarity of trophic levels.

\begin{figure}[hb!]
	\centering
	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/tl_stat_tests_v_wl"}
     \caption{Similar to figure \ref{fig:stat_tests_v_wl}, but here the tests are applied separately to each trophic level of the HI simulation. The four time series (TL$1-4$) represent the total number of individuals belonging to each trophic level at every iteration.} 
     \label{fig:tl_stat_tests_v_wl}   
\end{figure}

The dynamics of all the species belonging to each trophic level are plotted in figure \ref{fig:dynamics_by_species}. It is clear here that the community is dominated by a few abundant species, mainly in the lower trophic levels, with a large number of relatively scarce species. This is agrees with the rank abundance plots from chapters \ref{sec:whereis}, and with the long tailed distributions seen in real world communities. It also appears from this figure that the more abundant species exhibit large amplitude oscillations in their dynamics. This leads us to hypothesise that the most abundant species may be non-stationary, whereas the least abundant species may be stationary. We test this hypothesis by applying the ADF and KPSS tests to the three most abundant and three least abundant species in the HI simulation. Species are selected based on their average abundances over the whole simulation (minus the intial transience).  

\begin{figure}[ht!]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/hi_sp_by_tl_part10000"}
    \caption{Dynamics of every species in the first 10,000 iterations of the HI simulation, broken down by trophic level. Panels (A)-(D) show all the species belonging to each trophic level (TL$1-4$).}    
    \label{fig:dynamics_by_species}
\end{figure}

We see from figure \ref{fig:sp_stat_tests_v_wl} that all six species are stationary according to ADF, given sufficiently large sample size. However the sample size for all three of the abundant species to be stationary is greater (panel A: $\geq 9,000$ points) than for the three least abundant species (panel C: $\geq 2,000$ points). This suggests that the most abundant species are indeed `less stationary' than the least abundant species. The KPSS test supports this conclusion. KPSS finds that the three least abundant species are stationary above samples sizes of $\sim 18,000$, whereas two of the most abundant species are non-stationary for almost all sample sizes. Inspecting the dynamics in figure \ref{fig:dynamics_by_species} we see that these non-stationary species are those with largest amplitude fluctuations in their abundances. 

In general we conclude that the choice of metric used to generate the time series does affect the conclusions about stationarity. Overall we cannot be confident that the HI simulation is stationary, based on the results presented above for species, trophic and total abundances. This is largely due to the apparent strictness of the KPSS test. Considering species dynamics individually is the most informative. It allows for the possibility that some species abundances may be more variable than others, and information is not lost by aggregating.  In the following analysis we propose that stationarity tests should be applied to species dynamics, and then the number of stationary species (NSSP) used as an aggregate statistic. If NSSP equals the total number of species, then the community dynamics is fully stationary (according to the test used).   

%\begin{figure}[hp]
%	\centering
%    \subbottom[Sample size = 1000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/hi_sp_by_tl"}}
%    \subbottom[Sample size = 5000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/hi_sp_by_tl_part10000"}}
%        \caption{The dynamics of individual species.}    
%    \label{fig:dynamics_by_species}
%\end{figure}

\begin{figure}[hp]
	\centering
	\subbottom[Three most abundant species]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/sp_ma_stat_tests_v_wl"}}
		\subbottom[Three least abundant species]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/sp_la_stat_tests_v_wl"}}
     \caption{Similar to figure \ref{fig:stat_tests_v_wl}, but here the tests are applied separately to individual species from the HI simulation. (A) The abundance time series of three species with highest average abundances. (B) The three species with lowest average abundance.} 
     \label{fig:sp_stat_tests_v_wl}   
\end{figure}

\newpage
\subsection{Ensemble results}
\label{sec:ensemble}

The above tests are now applied to ensembles of simulations runs....We ran ensebmles with HI and LI and also 50 repeats with the same network....(copy/remove this repeated text from previous section...) We run 100 repeats of long 50,000 iteration simualtions, for the base case of zero HL and no mutualism. This is done for a high level of IR (0.001) and a low level of IR (0.0001). We will refer to these two cases here as high immigration (HI) and low immigration (LI) respectively. 


\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/hi_v_li_net7_ensemble"}
    \caption{The number of stationary species according to the two stationarity tests (ADF and KPSS), averaged over three different ensembles of simulations: HI(ensemble); HI(NM1) and LI(ensemble)  as described in the text. The first two are high immigration runs, whilst the latter is low immigration. Solid lines indicate the mean results for the ensemble, and error bars indicate $\pm 1$ standard deviation from the mean. (A) Each species abundance time series is sampled with a window of increasing length, as in figure \ref{fig:sp_stat_tests_v_wl}. (B) Each species series is sampled with a window of length wl=$3000$, which is scanned along the series as in figure \ref{fig:stat_tests_v_time}. For both tests results are interpretted at the $95\%$ confidence level.}    
    \label{fig:hi_v_li_net7_ensemble}
\end{figure}


\begin{figure}[hp]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/ras_3examples"}
    \caption{Rank abundance spectra (RAS) for three simulations run using the interaction network NM1 (see text). Species abundances are measured by taking the mean abundance over the final 1000 iterations of the simulation. The species are ranked according to their abundances in the first simulation (panel (A)). This odering is retained in panels (B) and (C), which represent different simulations. Colouring of species by trophic level is consistent with previous figures.}    
    \label{fig:ras_3examples}
\end{figure}

Which of these figures goes first??

\begin{figure}[h!]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/ras_dist"}
    \caption{The average rank abundace spectrum (RAS) for the ensemble of 50 simulations run using interaction network NM1 (see text). Species abundances measured as in figure \ref{fig:ras_3examples}, and ranked as in panel (A) of that figure. The main bars indicate mean abundance values, whilst the error bars indicate the minimum and maximum abundances over the ensemble.}    
    \label{fig:ras_dist}
\end{figure}


%% IF THIS IS INCLUDED IT GOES IN SECTION ON TESTING DIFFERENT MEASURMEENT PRCOEDURES...
%\begin{figure}[hp]
%	\centering
%    \subbottom[Sample size = 1000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/lowIR_v_highIR_wl1000"}}
%    \subbottom[Sample size = 5000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/lowIR_v_highIR_wl5000"}}
%        \caption{The effect of using different sample sizes on the sample mean and standard deviation. Dynamics generated using IBM simulation model with low and high IR (green and red respectively).}    
%    \label{fig:low_v_hi}
%\end{figure}

\subsection{Discussion}
\label{sec:stationarity_discussion}

The first two tests (ADF and KPSS) makes assumptions about the process that generated the data. For example, in the case of the ADF test, it is assumed that the data can be modelled as an autoregressive process. Grazzini \cite{grazzini2012analysis} refers to such tests as \emph{parametric} and points out that their simple assumptions about the data generator process may be too restrictive (REPHRASE) for time series generated by complex systems models, such as our IBM.  With this in mind we proceed with these tests because they are part of the standard set of tools currently used for time series analysis. Interestingly the PSR test and another, test proposed by Nason \cite{nason2013test} and based on wavelets analysis of the time varying power spectrum, do not reuqire such parameteric assumptions...waveletts..waveletss..

Regarding the PSR test - The test attempts to detect a time-varying power spectrum, as a signature of non-stationarity. This signature may be characteristic of adaptive dynamical systems, or systems exhibiting some kind of aperiodic dynamics. In general wavelets have proven a useful tool to study signals with time-dependent frequency spectra, and have found application in the analysis of non-stationary ecological time series \cite{cazelles2008wavelet, nason2013test}. However a preliminary investigation using the \emph{R} package \emph{biwavelet} did not appear fruitful and is not pursued further in this thesis\footnote{Although we may well refer back to this if we do discover chaos in the IBM!}. 


 This raise the question: what aspect of our simulated communities do we want to be stationary? (From a practical perspective - to obtain reliable results.) Many of the ecologcial metrics that we used in previous chapters depend on the relative abundances of species or trophic levels. It may be the case that the total number of individuals is stationary, but that the trophic or species level dynamics cause changes in community composition over time. Therefore we now look at how the stationarity tests perform at these two resolutions.

This raises the question: what aspect of our simulatied communities do we want, or expect to be stationary? Indeed, what about in real ecological communities? (see section \ref{sec:motivate_stationarity}).

\newpage
\section{Chaotic dynamics?}
\label{sec:chaos}

Although in many cases a statistical steady-state appears to be reached, there are complex dynamics and fluctuations within that state (see section \ref{whereis}).  Here we look at if these are due to noise or deterministic dynamics. We follow work presented by Saul in his PhD thesis \cite{saul09phd}. We also draw inspiration from the demonstration that plankton communities may undergo chaotic dynamics - \cite{beninca2008chaos}, and their focus on the Lyapunov exponent.


\section{Discussion}

This behaviour may or may not be seen in real communitites - chaotic dynamics have been demonstrated in plankton, how about terrestrial ecosystems? HOwever we come back again to limititations - snapshot measurements are taken - with replicate in time. Average over these? Check for differences between them - what is the actual procedure? Can we comment here? 

Computationally we should perhaps compare the appraoches of taking snapshots and averaging over many iterations...DISCUSS WTIH ALAN.

Other question - does it reach the same steady-ish state every time? Is it always the same species that dominate/just bubble along.


%% Note : simulations for the longer runs use 100 repeats with different networks. But the same networks are used for hi and lo IR simulations. Network 7 (simulation 8) was selected and run 50 repeats at hi immigration. Also a single repeat at each hi and lo IR were run with this network. We will also run:
%% > a simulation where everything is saved at every iteration (for video)
%% > this network for chaning HL and changing MAI ratio. All the above for an emprical food web!