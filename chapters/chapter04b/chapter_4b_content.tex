%TODO: Most abundant species osciallte more?Interesting question: is this true across the board, and are their oscillations only large in ampltitude because their mean is greater - what is the distribution of CoVs..later in chapter?
%TODO: revist chp3 results - CoV contigusous vs random HL \\
%TODO: replace ranomd walk with ARIMA? \\
%TODO: ensemble RW and NS with boxplots? \\
%TODO: Fix RAS plots (ordering) \\
%TODO: Test for determinism and chaos\\
%TODO: how do metrics vary with measurement length/through time - how likely get wrong result from snapshot (distribution of results?) \\
%TODO: Add species labels (most abundant) to species dynamics figure \\
%TODO: Fix labelling on least/most abundant stat test figure. Shuold be A-D. And in caption.  \\
%TODO: plot network 7 (NM1) ??
%TODO: fix xtick labels fig 1.9 - I.R wrong. Also resize!

\section{Motivation}
\label{sec:motivate_stationarity}

In the previous chapter we saw that under certain circumstances the population dynamics generated by the IBM becomes highly variable (see section \ref{sec:whereis}). This variability is measured by CoV, the temporal variability metric described in section \ref{sec:whereis}. In particular reducing the immigration rate (IR) is found to dramatically increase temporal variability. These immigration induced changes in CoV are much larger than those seen in chapter \ref{chap:whereis}, which were due to habitat destruction alone (and were restricted to a high immigration regime - IR=$0.005$)\footnote{There is also the as yet not fully explained result from two chapters ago that habitat destruction either increased or decreased temporal variability depending on the type of destruction (random or contiguous). This chapter does not yet address this but probably should.}. These findings bring into question certain assumptions implicit in the previous analyses, which are discussed below, and motivate the investigation of temporal variability which we undertake in this chapter. 

The primary concern of increased variability in the population dynamics is that it brings into question the validity of our results. In the previous analysis and in \cite{lurgi2015effects} the results are either calculated from a `snapshot' of the simulation state on the final (5000th) iteration, or in the case of the network metrics are calculated from aggregate interaction frequencies during the final 200 iterations. For results obtained in this way to be reliable the simulation must reach a sufficiently steady state after 5000 iterations. In the high immigration regime (HIR) it may not be unreasonable to assume that this is the case. In the HIR simulations that we inspected the main transient dynamics are contained within the first 1000 iterations, which is followed by a period of relatively constant abundance (see for example figure \ref{fig:hi_trophic_dynamics}). However we are now motivated to investigate `how constant' the simulations are after the initial transience, and how this might affect our results.  

The topic of this chapter is also relevant to our understanding of `real world' communities. The assumption that an ecosystem is in a \emph{steady-state} has often been often made \cite{brock1967ecosystem}. It is clear that ecosystems are dynamic, but they are remarkably robust and persistent in the face of environmental variability. For those who approach ecological theory from a dynamical systems perspective these properties are related to the dynamic stability of the system. Indeed to model an ecosystem as a dynamical system requires the existence of a stable equilibrium or attractor. However it is not clear how to relate the concept of dynamic stability to the temporal variability of population dynamics, which is frequently used as a proxy for stability (there is an interesting and in depth treatment of this issue in \cite{arnoldi2015}). In an extreme example there may exist a chaotic attractor, which is highly stable but which creates highly variable population dynamics. In such a case the steady-state assumption does not seem appropriate. 

In this chapter we conduct a detailed analysis of \emph{stationarity} in the communities simulated using the IBM model (section \ref{sec:stationarity}). We then move on to look at how our numerical results are affected by a lack of stationarity, and how this might be remedied (section \ref{sec:reliability}). Finally we close the chapter with some methods that attempt to uncover determinism and signatures of chaos from noisy dynamics.

%\begin{itemize}
%	\item Thermodynamic equilibrium is...therefore can talk about extrinsic state variables..
%	\item Different concepts of equilibirium in ecology - IBT suggest that island communities exists in a dynamic equilibirum between immigration and local extinctions..\cite{simberloff1974equilibrium}.
%\end{itemize}


%
%A reasonable hypothesis is that the dynamics contains a deterministic and a stochastic component. Determinsitic component must be stable..to explain lack of extinctions...Noise can induce oscialltions about stable equilibrium [REF]. Or the oscialltions may be deterministic in nature, suggesting a high dimensional attractor. Although this could be considered a steady-state, as discussed, it does not necessarily appear stationary. This would depend on the magnitude of the oscillations. This raises an important point about equilbria and stationarity, adn may motivate further types of test...

\section{Second-order stationarity}
\label{sec:stationarity}
%\begin{itemize}
%	\item Justify choice of weak-stationarity
%	\item discuss tests for weak stationarity e.g. Nason \cite{ref:nason2013test}. PSR. ADF. KPSS. define them.
%	\item mention use of wavelets in ecological time series - reffer to PSR test 		
%	\item Choice of metric to look at : total number of individuals, or by species?? (justify both..)
%\end{itemize}

We introduce here three tests for second-order (or `weak') stationarity in time series.  Second-order stationarity may be defined as the time invariance of the first and second moments of the data. Specifically Hsu \cite{hsu1997schaum} states that a random process $X(t), t \in \mathbf{Z}^+$ is second-order stationary if:

\begin{eqnarray*}
	\mathbf{E}[X(t)] &=& \mu \text{ (constant),} \\
	R_X(t,s) &=& \mathbf{E}[X(t)X(s)] = R_X(|s-t|), 
\end{eqnarray*}

where $R_X(t,s)$ is the \emph{autocorrelation} function of the process. Conceptually these conditions state that a second-order stationary time series has constant mean and autocorrelation dependent only on time separation. From now on we will refer to this just as \emph{stationary}. If the conditions are not met we call the time series \emph{non-stationary}, and we cannot parameterise a constant distribution for the data. Non-stationarity may be due, for example, to a trend in the data or a change in the parameters of the data generator. 

In our case the data generator is the IBM model and there are several possible causes of non-stationarity. It may be that there is no steady-state equilibrium in the model. For example the number of individuals may undergo a random-walk. From previous analysis this situation seems unlikely, since we have observed what appear to be deterministic population cycles. However randomness has not been explicitly tested for. Another possibility is that a steady-state equilibrium exists, but that a long transience  means it is not reached during the time frame of our simulations.

%%Intuitively this is the definition of stationarity we are looking for in the model output - if the generated time series is weakly stationary then the simulation has reached a steady state distribution, and the results that we take involve sampling from this distribution. The repeatability of the results then only depends on the properties of this dsitribution (we also need to look at individual species..see later). 

\subsection{Tests for stationarity}
\label{sec:stat_tests}

We compare three different tests of stationarity: the Kwiatkowski-Phillips-Schmidt-Shin (KPSS) \cite{kwiatkowski1992testing}; the Augmented Dickey-Fuller (ADF) \cite{said1984testing}; and the the Priestley-Subba Rao (PSR) \cite{priestley1969test} tests. These tests were chosen for their popularity in the time series literature. All three are implemented in the programming language \emph{R} \cite{Rlanguage} - the former two in the package \emph{tseries}, and the latter in the package \emph{fractal}.

The ADF test has null hypothesis that the time series is non-stationary. The test models the data as an auto-regressive process (see section \ref{sec:stationarity_discussion}), and the null hypothesis is that this process has a \emph{unit root}. The test produces a statistic that is negative. The greater the magnitude of the test statistic the more evidence there is to reject the null hypothesis in favour of stationarity.

The KPSS test complements the ADF test in that the null hypothesis is stationarity. The data is modelled as the sum of a random-walk and an error component, and tests the hypothesis that the variance of the random walk is zero. The test statistic is always positive, and the greater its magnitude the more evidence there is to reject the null hypothesis in favour of non-stationarity.

The null hypothesis of the PSR test is also that the series is stationary. The test is based on the idea that non-stationary processes have power spectra that change over time \cite{priestley1969test}. These are called \emph{evolutionary spectra}. The test, as implemented in \emph{R}, returns several statistics. We quote the `p-value for T' which can be thought of as the confidence that the estimated spectral density functions are constant in time.

\subsection{Characterising the tests}
\label{sec:characterising_stat_tests}

%% metnion that time series must be one-D??

To understand the performance of the stationarity tests (section \ref{sec:stat_tests}) we apply them to three example time series, which we refer to as HI, RW and NS. The first series, HI, is taken from a single IBM simulation run with high immigration rate (IR$=0.001$), zero mutualism (MAI$=0.0$) and otherwise default parameters (table \ref{tab:whereis}).  The series represents the total number of individuals of all species at each iteration. The simulation was run for 50,000 iterations, compared with the 5000 used in previous chapters. This increased length increases the chance of the simulation reaching stead-state, and allows comparison of tests applied to different sections of the series. The first 1000 iterations were discarded, since these contain clearly transient dynamics (see figure \ref{fig:hi_trophic_dynamics}B), leaving a time series of 49,000 points. A high immigration rate was chosen because it reduces the temporal variability of the dynamics, as was discussed in chapter \ref{chap:varying_immigration_rate}. Therefore the HI series is more likely to be stationary than the output of a simulation with a lower IR.

The series RW and NS are chosen as a negative and a positive control respectively. Both have the same length as HI. RW is a non-stationary series generated by a one-dimensional \emph{random-walk}, defined as:

\begin{equation}
	x(t) = \Sigma_{t}^{i=1} Z_i, 
\end{equation}   

where $Z_i$ are independent random variables that may take a value of either $-10$ or $+10$, both with probability half. An ensemble of such random walks was generated and a single instance was chosen with mean and variance closest to the HI series. RW has a mean and standard deviation of 15525.2 and 1549.8 respectively, compared to 15915.8 and 1545.6 for HI. For comparison, NS is a stationary series generated by drawing each value independently from a normal distribution with mean and variance  equal to that of HI. The three series are plotted in figure \ref{fig:adf}.
  
%We know that such a series is non-stationary in general (although it may appear stationary by chance?).
  
\begin{figure}[ht]
	\centering
	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/hi_rw_ns_dynamics"}
     \caption{The three time series used to characterise the performance of the stationarity tests. The intial 1000 points removed such that all are 49,000 points long. \textbf{(A) HI}: total abundance dynamics of an IBM simualtion with high immigration rate; \textbf{(B) RW}: a random walk without drift, as described in the text; and \textbf{(C) NS}: a series generated by independent sampling from a normal distribution.} 
     \label{fig:adf}   
\end{figure}

\begin{table}[h!]
\centering
\label{tab:adf_psr_kpss_whole}
\begin{tabular}{|
>{\columncolor[HTML]{C0C0C0}}c |c|
>{\columncolor[HTML]{9AFF99}}c |c|c|c|c|}
\hline
   & \multicolumn{2}{c|}{\cellcolor[HTML]{C0C0C0}A.D.F.}                 & \multicolumn{2}{c|}{\cellcolor[HTML]{C0C0C0}P.S.R.}              & \multicolumn{2}{c|}{\cellcolor[HTML]{C0C0C0}K.P.S.S.}                  \\ \hline
   & \cellcolor[HTML]{C0C0C0}stat & \cellcolor[HTML]{C0C0C0}p-value      & \cellcolor[HTML]{C0C0C0}stat & \cellcolor[HTML]{C0C0C0}p-value   & \cellcolor[HTML]{C0C0C0}stat & \cellcolor[HTML]{C0C0C0}p-value         \\ \hline
HI & -15.401                      & {\color[HTML]{333333} \textless0.01} & -                            & 0.0004782808                      & 0.5395                       & 0.03277                                 \\ \hline
RW & -4.0386                      & {\color[HTML]{333333} \textless0.01} & -                            & \cellcolor[HTML]{9AFF99}0.9929773 & 18.7453                      & \textless0.01                           \\ \hline
NS & -37.5348                     & {\color[HTML]{333333} \textless0.01} & -                            & \cellcolor[HTML]{9AFF99}0.811097  & 0.0466                       & \cellcolor[HTML]{9AFF99}\textgreater0.1 \\ \hline
\end{tabular}
\caption{Results of applying the three stationarity tests to the example time series shown in figure \ref{fig:adf}. P-values that indicate evidence for stationarity at $95\%$ confidence are highlighted in green. The test statistics are also given for the ADF and KPSS tests.}
\end{table}

Initially we apply the three stationarity tests to the entire length of the time series. The results are shown in table \ref{tab:adf_psr_kpss_whole}. ADF finds significant evidence that all three series are stationary, at $99\%$ confidence. We may be suspicious of this result since we know that RW is generated by a non-stationary process.  However this is a special case of a random walk, chosen from several thousand to closely match the mean and variance of HI. Therefore it may not be unreasonable that it can pass as stationary. The test statistic for ADF indicates that there is most evidence for NS to be stationary, followed by HI, then RW.
  The KPSS test ranks the series in the same order, based on the magnitude of the test statistic. According to this test NS is clearly stationary (accept h0), and RW is clearly non-stationary (reject h0 at $99\%$ confidence), whilst HI is borderline. For HI we would accept the null-hypothesis of stationarity at $95\%$ confidence, but reject it at $99\%$. 

The PSR test gives unexpected results. It concludes that RW and NS are both stationary, whilst HI is non-stationary with a high degree of confidence (p-value$<0.001$). In fact, according to PSR, RW is more likely to be stationary than NS. This result contradicts what we know about the series. Therefore we do not use this test in the analysis that follows. However the apparently erroneous result may contain interesting information about the HI series and the process that generated it (see discussion in section \ref{sec:stationarity_discussion}. 


%% WUOLD BE NICE BUT ANALYSIS NEEDS RE-DOING...
%\begin{figure}[hp]
%	\centering
%    \subbottom[Sample size = 1000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/hi_rw_ns_zscore_wl1000"}}
%    \subbottom[Sample size = 5000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/hi_rw_ns_zscore_wl5000"}}
%        \caption{The z-statistic used to test the null hypothesis that sample means are drawn from the stationary distribution. Each dot indicates a sample from the dynamics, which is tested.}    
%    \label{fig:zscore}
%\end{figure}


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.80\linewidth]{"./chapters/chapter04b/figures/Rtests/stat_tests_v_wl"}
     \caption{Two tests for stationarity applied to samples of varying size (window length). Samples are taken from the three time series (HI,RW,NS) shown in figure \ref{fig:adf}. All three time series contain 49,000 points. Sample windows begin at the first point and increase in length from 1000 to 49,000 points. Points plotted at 0.01 indicate p-values less than or equal to this. (A) ADF test, with p-values capped at 0.20. 95th and 99th percentile in yellow and green respectively, indicating significant vidence for stationarity. (B) KPSS test, with p-values capped at 0.1. 95th and 99th percentile in orange and red respectively, indicating significant evidence for non-stationarity.} 
     \label{fig:stat_tests_v_wl}   
\end{figure}

Having discarded the PSR test, we now apply ADF and KPSS to samples of varying sizes, taken from the three series (HI,RW,NS). Sampling begins at the first point of the series and takes consecutive points up to the desired length of samples. Sample lengths range from 1000 to 49,000 data points. Again, as we saw in table \ref{tab:adf_psr_kpss_whole}, the two tests perform differently. The KPSS test correctly identifies RW and NS as non-stationary and stationary respectively, for all sample sizes. This is shown in figure \ref{fig:stat_tests_v_wl}B. The ADF test (figure \ref{fig:stat_tests_v_wl}A) correctly identifies NS as stationary for all sample sizes.  For short sample sizes it also correctly identifies RW as non-stationary. However, for sample sizes much above 20,000, ADF finds significant evidence that RW is stationary at $95\%$ confidence. This is an interesting result. Although RW is generated by a non-stationary process, it appears to fool the ADF test by staying `stationary enough' over many time points. 
  
There is mixed evidence for the stationarity of HI, as shown in figure \ref{fig:stat_tests_v_wl}. ADF, for all sample sizes above 2000, finds significant evidence that HI is stationary. Whereas KPSS, on the whole, gives significant evidence that HI is non-stationary - There are only seven cases where there is insufficient evidence to reject the null hypothesis that the HI series is stationary, and these occur at sample sizes between 24,000 and 34,000. From these results it appears that the KPSS test is a stricter test of stationarity, and is less sensitive to the size of the sample. Although it appears that the ADF test is biased in favour of stationarity, it does order the series correctly in the above examples and is a useful complement to KPSS. Also it may be that the sensitivity of ADF to sample length is useful, since processes may appear stationary/non-stationary at different scales. 

We consider the possibility that the method of sampling from the time series affects the results of the stationarity tests. For example samples taken near the beginning of an IBM simulation run may be more likely to give the non-stationary series because of transient dynamics. Alternatively a non-stationary data generator may produce sections of time series that appear stationary purely by chance. This sensitivtiy to sampling is investigated by \emph{reversing} the time series and repeating the above analysis. For HI, RW and NS we see no qualitative change in the results presented above. We also scan sampling windows of fixed length along the series to look for time dependence in the test results. The time at which samples are taken appears to make no qualitative difference, and there is no systematic change in the results that would suggest the simulation becomes more stationary the longer it is run\footnote{Note that this is not necessarily the case when we move to lower IRs.}. 


%% THINK THIS IS NOT NEED TO CHARACTERISE THE TESTS..MAYBE JUST DISCUSS IN THE TEXT?
%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/stat_tests_v_time"}
%     \caption{Similar to figure \ref{fig:stat_tests_v_wl} but with samples of fixed sample size taken from different parts of the time series. To sample windows of given length (wl) are moved along the series and the tests are applied to the sub-series that falls within the window. Results are plotted against the mid-point of the window.}
%     \label{fig:stat_tests_v_time}   
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"./chapters/chapter04b/figures/hi_trophic_dynamics"}
     \caption{Dynamics for the HI simulation, broken down by trophic level ($TL1-4$). Abundance is measured by the number of individuals. (A) The whole simulation run of 50,000 iterations. (B) Enlaregement of first 1000 iterations, showing transience.} 
     \label{fig:hi_trophic_dynamics}   
\end{figure}


\paragraph*{HI simulation.}
We now focus on the simulation data used to generate HI and look in more depth at whether this dataset can be considered stationary. We use the same two tests, ADF and KPSS, for the stationarity of univariate time series. Since our abundance vector is 60-dimensional ($N=60$ species), it is necessary to perform some manipulation to get a time series we can test. Previously we used the total number of individuals as our time series. However simply summing over species (l1-norm) is not necessarily the most informative metric to use. One possible issue is that the phase differences between species oscillations that we would expect due to trophic interactions (see chapter \ref{chap:whereis}) may mean that temporal variability is cancelled out when aggregating abundances in this way. It is possible that simulations which appear stationary according to some aggregate metric (e.g. total number of species) may have non-stationary underlying dynamics. This suggests that it is most informative to consider stationartiy at the species level. We also consider the stationarity of abundances by trophic level, as an alternative aggregate metric.

The dynamics of the HI simulation are aggregated by trophic level to create four new time series TL$1-4$. These \emph{trophic dynamics} are plotted in figure \ref{fig:hi_trophic_dynamics}. The initial period of transience is expanded in panel B. As in the previous analysis this part of the time series (first 1000 iterations) is removed. The ADF and KPSS tests are applied to the four trophic series separately and the results are shown in figure \ref{fig:tl_stat_tests_v_wl}. According to ADF all trophic levels are stationary for samples sizes greater than 4000. TL1 appears to be least stationary according to ADF, requiring a sample size of at least 4000 before to reject the null hypothesis at $95\%$ confidence. According to KPSS TL1 is non-stationary for all sample sizes, whilst TL2 and 3 are stationary for samples sizes above 6000 and 1000 respectively. KPSS gives mixed results for TL4, with no clear dependnence on sample size. It is hard to reconcile these results with an observation of the dynamics in figure \ref{fig:hi_trophic_dynamics}, indicating the usefulness of the statistical tests. It may be informative to consider if there are general trends in the stationarity of trophic levels.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/tl_stat_tests_v_wl"}
     \caption{Similar to figure \ref{fig:stat_tests_v_wl}, but here the tests are applied separately to each trophic level of the HI simulation. The four time series (TL$1-4$) represent the total number of individuals belonging to each trophic level at every iteration.} 
     \label{fig:tl_stat_tests_v_wl}   
\end{figure}

The dynamics of all the species belonging to each trophic level are plotted in figure \ref{fig:dynamics_by_species}. It is clear here that the community is dominated by a few abundant species, mainly in the lower trophic levels, with a large number of relatively scarce species. This is agrees with the rank abundance plots from chapters \ref{sec:whereis}, and with the long tailed distributions seen in real world communities. It also appears from this figure that the more abundant species exhibit large amplitude oscillations in their dynamics. This leads us to hypothesise that the most abundant species may be non-stationary, whereas the least abundant species may be stationary. We test this hypothesis by applying the ADF and KPSS tests to the three most abundant and three least abundant species in the HI simulation. Species are selected based on their average abundances over the whole simulation (minus the intial transience).  

\begin{figure}[ht!]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/hi_sp_by_tl_part10000"}
    \caption{Dynamics of every species in the first 10,000 iterations of the HI simulation, broken down by trophic level. Panels (A)-(D) show all the species belonging to each trophic level (TL$1-4$).}    
    \label{fig:dynamics_by_species}
\end{figure}

We see from figure \ref{fig:sp_stat_tests_v_wl} that all six species are stationary according to ADF, given sufficiently large sample size. However the sample size for all three of the abundant species to be stationary is greater (panel A: $\geq 9,000$ points) than for the three least abundant species (panel C: $\geq 2,000$ points). This suggests that the most abundant species are indeed `less stationary' than the least abundant species. The KPSS test supports this conclusion. KPSS finds that the three least abundant species are stationary above samples sizes of $\sim 18,000$, whereas two of the most abundant species are non-stationary for almost all sample sizes. Inspecting the dynamics in figure \ref{fig:dynamics_by_species} we see that these non-stationary species are those with largest amplitude fluctuations in their abundances. 

In general we conclude that the choice of metric used to generate the time series does affect the conclusions about stationarity. Overall we cannot be confident that the HI simulation is stationary, based on the results presented above for species, trophic and total abundances. This is largely due to the apparent strictness of the KPSS test. Considering species dynamics individually is the most informative. It allows for the possibility that some species abundances may be more variable than others, and information is not lost by aggregating.  In the following analysis we propose that stationarity tests should be applied to species dynamics, and then the number of stationary species (NSSP) used as an aggregate statistic. If NSSP equals the total number of species, then the community dynamics is fully stationary (according to the test used).   

%\begin{figure}[hp]
%	\centering
%    \subbottom[Sample size = 1000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/hi_sp_by_tl"}}
%    \subbottom[Sample size = 5000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/hi_sp_by_tl_part10000"}}
%        \caption{The dynamics of individual species.}    
%    \label{fig:dynamics_by_species}
%\end{figure}

\begin{figure}[hp]
	\centering
	\subbottom[Three most abundant species]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/sp_ma_stat_tests_v_wl"}}
		\subbottom[Three least abundant species]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/Rtests/sp_la_stat_tests_v_wl"}}
     \caption{Similar to figure \ref{fig:stat_tests_v_wl}, but here the tests are applied separately to individual species from the HI simulation. (A) The abundance time series of three species with highest average abundances. (B) The three species with lowest average abundance.} 
     \label{fig:sp_stat_tests_v_wl}   
\end{figure}

\newpage
\subsection{Stationarity results}
\label{sec:ensemble}

We now pursue a general investigation of the stationarity of communities simulated with the IBM model. First we test the stationarity of three ensembles of new simulation runs (figure \ref{fig:hi_v_li_net7_ensemble}). Secondly we test the simulations used to generate the results presented in the previous chapter (figures \ref{fig:nssp_ir_v_hl},\ref{fig:nssp_v_ir_and_hl}). The new simulations usd default parameters, unless otherwise specified, and are run for 50,000 iterations. Two ensembles of 100 simulations each are run for high (IR$=0.001$) and low (IR$=0.0001$) immigration rates, which we refer to here as the HI and LI ensembles respectively. A third ensemble of 50 shorter simulations (10,000 iterations) is run, at high immigration rate, using a fixed interaction network, which we call the NM1 ensemble. All networks are generated using the niche model as described in section \ref{sec:whereis}, with zero mutualism (MAI=$0.0$). Each simulation uses a uniquely generated network, except for those of the NM1 ensemble. Stationarity testing is done using the ADF and KPSS tests characterised in section \ref{sec:characterising_stat_tests} above. As standard the initial 1000 iterations are discarded in an attempt to remove transience. The tests are then applied to a sample taken from the abundance time series of each species. The results presented in this section give the number of stationary species (NSSP) in the community, at the $95\%$ confidence level.

As the length of the samples taken from the abundance time series increases, the average NSSP also increases. This is true of both tests and for all three ensembles, as we can see from figure \ref{fig:hi_v_li_net7_ensemble}A. According to ADF all species are stationary, on average, for sufficiently large sample length. The required length of sample is larger for the LI ensemble than for HI. For KPSS, although the NSSP does increase with sample length, it is not clear that it will asymptotically approach 60 species in the limit of many iterations. The average NSSP at 49,000 sample points is just under 40 and   just over 20 for HI and LI ensembles respectively.

To check the time dependence of stationarity (i.e. are species more likely to be stationary after many iteration of a simulation?) samples of length 3000 were taken from different points along the time series. From figure \ref{fig:hi_v_li_net7_ensemble}B we can see that there is no clear trend in in stationarity over 49,000 iterations. The average NSSP is almost the same whether the sample is taken from iterations 1000-3000 or 46,000-49,000. This result also holds for windows of different length, which are not plotted here.

On average we see that the LI ensemble is less stationary than the HI ensemble. This we expected from the results of chapter \ref{chap:whereis}. However we cannot be confident that either ensemble contains communities with stationary species distributions. This may be problematic for the interpretation of our results, and we discuss this further below. Interestingly the NM1 ensemble gives very similar results to the HI ensemble. This may be because we have accidentally chosen NM1 to closely resemble the average of this ensemble (see both panels of figure \ref{fig:hi_v_li_net7_ensemble}. Alternatively it may be that stationarity of the simulation output is not dependent on the interaction network structure. Again, we will return to this issue in what follows.

\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/hi_v_li_net7_ensemble"}
    \caption{The number of stationary species (NSSP) according to the two stationarity tests (ADF and KPSS), averaged over three different ensembles of simulations: HI(ensemble); HI(NM1) and LI(ensemble)  as described in the text. The first two are high immigration runs, whilst the latter is low immigration. Solid lines indicate the mean results for the ensemble, and error bars indicate $\pm 1$ standard deviation from the mean. (A) Each species abundance time series is sampled with a window of increasing length, as in figure \ref{fig:sp_stat_tests_v_wl}. (B) Each species series is sampled with a window of length wl=$3000$, which is scanned along the series as in figure \ref{fig:stat_tests_v_time}. For both tests results are interpretted at the $95\%$ confidence level.}    
    \label{fig:hi_v_li_net7_ensemble}
\end{figure}

\paragraph*{Previous simulations.} The simulations from chapter \ref{chap:wehereis} are tested for stationarity. All simulations are 5000 iterations long. The initial 1000 iterations is discarded and the ADF and KPSS tests applied, species by species, to the remaining 4000. Figure \ref{fig:nssp_ir_v_hl} shows the average NSSP across the region of parameter space investigated, for three MAI ratios (MAI$=0.0,0.5,1.0$). The results are qualitatively the same for both tests, although NSSP is higher for ADF than for KPSS as expected. On average reducing IR reduces the NSSP. A weaker effect, but still visible is that increasing HL reduces the NSSP. Most striking is the effect of MAI ratio on stationarity - the average NSSP is greater across the whole parameter region at MAI$=0.0$ than at MAI$=1.0$, with MAI=$0.5$ in between. Increasing mutualism also appears to reduce the dependence of NSSP on IR.  Figure \ref{fig:nssp_v_ir_and_hl} summarises these trends with cross sections taken from the heat maps in figure \ref{fig:nssp_ir_v_hl}, with error bars added. It is clear that there is high variability across replicate simulations, and this variability appears to be greatest for high mutualism (MAI=$1.0$).

\begin{figure}[hp]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/nssp_ir_v_hl"}
    \caption{The average number of stationary species (NSSP) according to the two stationarity tests (ADF and KPSS), across the slice of parameter space explored in chapter \ref{chap:whereis}. All simulations are 5000 iterations. Tests are applied to final 4000 iterations.}    
    \label{fig:nssp_ir_v_hl}
\end{figure}



\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\linewidth]{"./chapters/chapter04b/figures/nssp_v_ir_and_hl"}
    \caption{The number of stationary species (NSSP) according to the ADF test. The points show mean numbers and error bars show $\pm$ one standard deviation. Tests are performed on the same simulations depicted in figure \ref{fig:nssp_ir_v_hl}. (A) Plotted against immigration rate (IR), with zero habitat destruction. (B) Plotted against habitat destruction, with IR$=0.001$. }    
    \label{fig:nssp_v_ir_and_hl}
\end{figure}

\subsection{Discussion}
\label{sec:stationarity_discussion}

Main conclusion: communities not guaranteed stationary, even in high immigration regime. Most important question - how does this affect our results? (next section) Second most important question: why are they not stationary? Hypothesis: deterministic chaos (final section)? - surely stochastic fluctuation about a stable equilibrium would be pretty stationary?

Importantly there is no evidence that the simulations are getting more stationary as they go on. This means we do not need to throw away all previous results! But may need to reconsider how to calculate them..

If not already done, talk about relative abundances of species and if these change due to oscillations..

Perhaps discuss here stationary in real world communities (plankton, and look for more examples).

Also discuss parametric tests and frequncy spectra:

The first two tests (ADF and KPSS) makes assumptions about the process that generated the data. For example, in the case of the ADF test, it is assumed that the data can be modelled as an autoregressive process. Grazzini \cite{grazzini2012analysis} refers to such tests as \emph{parametric} and points out that their simple assumptions about the data generator process may be too restrictive (REPHRASE) for time series generated by complex systems models, such as our IBM.  With this in mind we proceed with these tests because they are part of the standard set of tools currently used for time series analysis. Interestingly the PSR test and another, test proposed by Nason \cite{nason2013test} and based on wavelets analysis of the time varying power spectrum, do not reuqire such parameteric assumptions...waveletts..waveletss..

Regarding the PSR test - The test attempts to detect a time-varying power spectrum, as a signature of non-stationarity. This signature may be characteristic of adaptive dynamical systems, or systems exhibiting some kind of aperiodic dynamics. In general wavelets have proven a useful tool to study signals with time-dependent frequency spectra, and have found application in the analysis of non-stationary ecological time series \cite{cazelles2008wavelet, nason2013test}. However a preliminary investigation using the \emph{R} package \emph{biwavelet} did not appear fruitful and is not pursued further in this thesis\footnote{Although we may well refer back to this if we do discover chaos in the IBM!}. 





\section{Reliability of results}
\label{sec:reliability}

Since we cannot be certain over stationartiy, especially within 5000 iterations with variable IR!..we now look at what this means for reliability our results..

\subsection{Abundances}

This analysis uses two metrics, both of which require the hypothesis that each species has an equilibirum abundance or long-term average abundance, which is well approximated by the mean abundance between 1000 and 50,000 iteration in the long simulations. (This is related to the idea of repeatability, which we look at below - is this long term average the same...RAS etc. for NM1)

Ideally we need to look at HI ensemble for IR=0.005 to justify original `snapshot' sampling - ask Alan.\\
**Need a plot to show how MRE is calculated..
%% These plots are a bit crap - how to improve?
\begin{figure}[hp]
	\centering
	\subbottom[]{\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/Reliability/LI/most_and_least_abun_species_dynamics"}}
	\subbottom[]{\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/Reliability/LI/most_and_least_abun_species_dynamics_maf_wl4000"}}
		
    \caption{Example of speices dynamics with and without averaging.}    
    \label{fig:maf_example}
\end{figure}

\begin{figure}[hp]
	\centering
	\subbottom[HI ensemble]{\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/Reliability/LI/three_estimator_regression"}}
	\subbottom[LI ensemble]{\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/Reliability/HI/three_estimator_regression"}}    
    \caption{Example of linear regression with the three estimators.}    
    \label{fig:regression_exmaple}
\end{figure}

\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/Reliability/error_versus_estimator"}
    \caption{Abundance estimator performance - use this to justify the way we take our measurements from simulations! The first estimator is a `snapshot' at 5000th iteration, the rest are averages of windows ranging from legnth 1000 to 50,000 in steps of 1000.}    
    \label{fig:error_versus_estimator}
\end{figure}

In this section we look at how reliable results are, how sensitive they are to different ways of measuring, and different lengths of averaging. 

At the end of the section we also look at repeatability using the ensemble NM1. And introduce RAS spectra.

\subsection{Variability: CoV}

Here we look at the CoV - how does it depends on the length of window used? 200 was used initially..

We may also look at CoV (or stationarity again) versus mean species abundance - do the more abundant species have higher temporal variability?

\subsection{Repeatability}

\begin{figure}[hp]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/ras_3examples"}
    \caption{Rank abundance spectra (RAS) for three simulations run using the interaction network NM1 (see text). Species abundances are measured by taking the mean abundance over the final 1000 iterations of the simulation. The species are ranked according to their abundances in the first simulation (panel (A)). This odering is retained in panels (B) and (C), which represent different simulations. Colouring of species by trophic level is consistent with previous figures.}    
    \label{fig:ras_3examples}
\end{figure}


Repeats communites - do they always do the same things...NM1

\begin{figure}[h!]
	\centering
	\includegraphics[width=1.0\linewidth]{"./chapters/chapter04b/figures/ras_dist"}
    \caption{The average rank abundace spectrum (RAS) for the ensemble of 50 simulations run using interaction network NM1 (see text). Species abundances measured as in figure \ref{fig:ras_3examples}, and ranked as in panel (A) of that figure. The main bars indicate mean abundance values, whilst the error bars indicate the minimum and maximum abundances over the ensemble.}    
    \label{fig:ras_dist}
\end{figure}


\section{Determinism and Chaos}
\label{sec:determinism}

We use two tests for determinism....cite cite...

Chaos - Although in many cases a statistical steady-state appears to be reached, there are complex dynamics and fluctuations within that state (see section \ref{whereis}).  Here we look at if these are due to noise or deterministic dynamics. We follow work presented by Saul in his PhD thesis \cite{saul09phd}. We also draw inspiration from the demonstration that plankton communities may undergo chaotic dynamics - \cite{beninca2008chaos}, and their focus on the Lyapunov exponent.

%% IF THIS IS INCLUDED IT GOES IN SECTION ON TESTING DIFFERENT MEASURMEENT PRCOEDURES...
%\begin{figure}[hp]
%	\centering
%    \subbottom[Sample size = 1000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/lowIR_v_highIR_wl1000"}}
%    \subbottom[Sample size = 5000 iterations]{\includegraphics[width=0.8\linewidth]{"./chapters/chapter04/figures/steadystate/lowIR_v_highIR_wl5000"}}
%        \caption{The effect of using different sample sizes on the sample mean and standard deviation. Dynamics generated using IBM simulation model with low and high IR (green and red respectively).}    
%    \label{fig:low_v_hi}
%\end{figure}


\newpage

\section{Discussion}

This behaviour may or may not be seen in real communitites - chaotic dynamics have been demonstrated in plankton, how about terrestrial ecosystems? HOwever we come back again to limititations - snapshot measurements are taken - with replicate in time. Average over these? Check for differences between them - what is the actual procedure? Can we comment here? 

Computationally we should perhaps compare the appraoches of taking snapshots and averaging over many iterations...DISCUSS WTIH ALAN.

Other question - does it reach the same steady-ish state every time? Is it always the same species that dominate/just bubble along.


%% Note : simulations for the longer runs use 100 repeats with different networks. But the same networks are used for hi and lo IR simulations. Network 7 (simulation 8) was selected and run 50 repeats at hi immigration. Also a single repeat at each hi and lo IR were run with this network. We will also run:
%% > a simulation where everything is saved at every iteration (for video)
%% > this network for chaning HL and changing MAI ratio. All the above for an emprical food web!